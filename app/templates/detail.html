{% extends 'base.html' %}

{% block navbar %}
<a href="/" class="btn btn-primary">Back to sandbox listing</a>
{% endblock %}

{% block content %}
<h1>Sandbox {{ namespace }} details</h1>

{% for link in sandbox.links %}
{% if link.icon.startswith("https://") %}
<a href="{{ link.url }}" target="_blank"><img src="{{ link.icon }}" style="max-width: 32px; max-height: 32px;"/></a>
{% else %}
<a href="{{ link.url }}" class="btn btn-primary" target="_blank"><i class="{{ link.icon }}"></i></a>
{% endif %}
{% endfor %}

<button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#delete-confirmation">Delete</button>
<br/>
<br/>
<nav>
  <div class="nav nav-tabs" id="nav-tab" role="tablist">
    <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">Cluster access</button>
    <button class="nav-link" id="nav-pod-tab" data-bs-toggle="tab" data-bs-target="#nav-pod" type="button" role="tab" aria-controls="nav-pod" aria-selected="false">Running pods</button>
    <button class="nav-link" id="nav-ingress-tab" data-bs-toggle="tab" data-bs-target="#nav-ingress" type="button" role="tab" aria-controls="nav-ingress" aria-selected="false">Ingresses</button>
    <button class="nav-link" id="nav-dev-tab" data-bs-toggle="tab" data-bs-target="#nav-dev" type="button" role="tab" aria-controls="nav-dev" aria-selected="false">Developing</button>
  </div>
</nav>
<div class="tab-content" id="nav-tabContent">
  <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
    <div class="modal fade" id="delete-confirmation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Sandbox delete confirmation</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete sandbox {{ sandbox.namespace }}?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <a href="/sandbox/{{ sandbox.namespace }}/delete" type="submit" class="btn btn-danger">Confirm</a>
          </div>
        </div>
      </div>
    </div>
    <h2>Sandbox access</h2>
    <p>To configure cluster access run following snippet,
    it creates a Kubernetes client context named {{ sandbox.cluster.name }}/{{ sandbox.namespace }}:
    <pre>
cat << EOF > kubeconfig-new
apiVersion: v1
kind: Config
clusters:
  - name: {{ sandbox.cluster.name }}
    cluster:
      server: {{ sandbox.cluster.server }}{% if sandbox.cluster['certificate-authority-data'] %}
      certificate-authority-data: {{ sandbox.cluster['certificate-authority-data'] }}{% endif %}
contexts:
  - name: {{ sandbox.cluster.name }}/{{ sandbox.namespace }}
    context:
      user: {{ sandbox.cluster['oidc-issuer-url'] }}
      cluster: {{ sandbox.cluster.name }}
      namespace: {{ sandbox.namespace }}
users:
  - name: {{ sandbox.cluster['oidc-issuer-url'] }}
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        command: kubectl
        args:
          - oidc-login
          - get-token
          - --listen-address=127.0.0.1:27890
          - --oidc-issuer-url={{ sandbox.cluster['oidc-issuer-url'] }}
          - --oidc-client-id=kubelogin
          - --oidc-use-pkce
          - --oidc-extra-scope=profile,email,groups
EOF
KUBECONFIG="$HOME/.kube/config:kubeconfig-new" kubectl config view --raw > kubeconfig-merged
mv kubeconfig-merged $HOME/.kube/config
rm -fv kubeconfig-new
    </pre>
    <h2>Frequently used commands:</h2>
    <pre>kubectl apply --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }} -f foobar.yaml</pre>
    <pre>kubectl get deployments --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }}</pre>
    <pre>kubectl get statefulsets --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }}</pre>
  </div>
  <div class="tab-pane fade" id="nav-pod" role="tabpanel" aria-labelledby="nav-pod-tab">
    <p>To interact on command line:</p>
    <pre>kubectl get pods --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }}</pre>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">Pod name</th>
          <th scope="col">Status</th>
          <th scope="col">Links</th>
        </tr>
      </thead>
      <tbody>
        {% for pod in pods %}
        <tr>
          <td>{{ pod.metadata.name }}</td>
          <td>{{ pod.status.phase }}</td>
          <td>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#pod-snippets-{{ pod.metadata.name }}"><i class="fas fa-terminal"></i></button>
            <div class="modal fade" id="pod-snippets-{{ pod.metadata.name }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Command line snippets for this pod</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <p>Pod details:</p>
                    <pre>kubectl get -o wide \
pod/{{ pod.metadata.name }} \
  --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }}</pre>
                    <p>Pod status:</p>
                    <pre>kubectl describe \
pod/{{ pod.metadata.name }} \
  --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }}</pre>
                    <p>Pod logs:</p>
                    <pre>kubectl logs \
pod/{{ pod.metadata.name }} \
  --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }}</pre>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
            {% for link in pod.links %}
            {% if link.icon.startswith("https://") %}
            <a href="{{ link.url }}" target="_blank"><img src="{{ link.icon }}" style="max-width: 32px; max-height: 32px;"/></a>
            {% else %}
            <a href="{{ link.url }}" class="btn btn-primary" target="_blank"><i class="{{ link.icon }}"></i></a>
            {% endif %}
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="tab-pane fade" id="nav-ingress" role="tabpanel" aria-labelledby="nav-ingress-tab">
    <p>To list all <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank">services</a> in this sandbox</p>
    <pre>kubectl get svc --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }}</pre>
    <p>To list all <a href="https://kubernetes.io/docs/concepts/services-networking/service/#endpoints" target="_blank">endpoints</a> in this sandbox</p>
    <pre>kubectl get ep --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }}</pre>
    <p>To list all <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank">ingress rules</a> in this sandbox</p>
    <pre>kubectl get ing --context {{ sandbox.cluster.name }}/{{ sandbox.namespace }}</pre>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">URL</th>
          <th scope="col">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for i in ingress %}
        {% for rule in i.spec.rules %}
        <tr>
          <td><a href="https://{{ rule.host }}" target="_blank">{{ rule.host }}</a></td>
          <td>&nbsp;</td>
        </tr>
        {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="tab-pane fade" id="nav-dev" role="tabpanel" aria-labelledby="nav-dev-tab">
    <h2>Developing with Skaffold</h2>
    <p>To <a href="https://skaffold.dev/docs/install/">Skaffold</a> develop using one of the template repositories for
    <a href="https://github.com/codemowers/hello-python">Flask</a>,
    <a href="https://github.com/codemowers/hello-nodejs">Express.js</a>:
    </p>
    <pre>skaffold dev --kube-context {{ sandbox.cluster.name }}/{{ sandbox.namespace }} --default-repo {{ sandbox.registry.hostname }}/{{ sandbox.parameters.username }} --namespace {{ sandbox.namespace }}</pre>
    <h2>Building locally with Docker</h2>
    <p>In some cases you might want to have Skaffold run <code>docker build</code>
    locally. In that case create robot account at <a href="https://{{ sandbox.registry.hostname }}" target="_blank">Harbor</a> and issue <code>docker login {{ sandbox.registry.hostname }}</code> on your workstation.
    <p>To reconfigure Skaffold either comment or remove <code>build.cluster</code> section in the <code>skaffold.yaml</code> file</p>
  </div>
</div>
{% endblock %}
